<?php

// If uninstall not called from WordPress, then exit.
if ( ! defined( 'WP_UNINSTALL_PLUGIN' ) ) {
	exit;
}

// Delete Options
delete_option('nis2_enabled');
delete_site_option('nis2_enabled');
delete_option('nis2_data_retention');
delete_site_option('nis2_data_retention');
delete_option('nis2_organization_type');
delete_site_option('nis2_organization_type');
delete_option('nis2_report_language');
delete_site_option('nis2_report_language');
delete_option('nis2_timezone');
delete_site_option('nis2_timezone');
delete_option('nis2_logging_enabled');
delete_site_option('nis2_logging_enabled');
delete_option('nis2_log_retention_days');
delete_site_option('nis2_log_retention_days');
delete_option('nis2_log_level');
delete_site_option('nis2_log_level');
delete_option('nis2_log_event_types');
delete_site_option('nis2_log_event_types');
delete_option('nis2_log_integration_mode');
delete_site_option('nis2_log_integration_mode');
delete_option('nis2_import_existing_logs');
delete_site_option('nis2_import_existing_logs');
delete_option('nis2_webhook_enabled');
delete_site_option('nis2_webhook_enabled');
delete_option('nis2_webhook_url');
delete_site_option('nis2_webhook_url');
delete_option('nis2_webhook_secret');
delete_site_option('nis2_webhook_secret');
delete_option('nis2_syslog_enabled');
delete_site_option('nis2_syslog_enabled');
delete_option('nis2_email_notifications');
delete_site_option('nis2_email_notifications');
delete_option('nis2_alert_frequency');
delete_site_option('nis2_alert_frequency');
delete_option('nis2_db_optimization');
delete_site_option('nis2_db_optimization');
delete_option('nis2_log_compression');
delete_site_option('nis2_log_compression');
delete_option('nis2_rate_limit_enabled');
delete_site_option('nis2_rate_limit_enabled');
delete_option('nis2_rate_limit_attempts');
delete_site_option('nis2_rate_limit_attempts');
delete_option('nis2_rate_limit_period');
delete_site_option('nis2_rate_limit_period');
delete_option('nis2_captcha_enabled');
delete_site_option('nis2_captcha_enabled');
delete_option('nis2_captcha_site_key');
delete_site_option('nis2_captcha_site_key');
delete_option('nis2_captcha_secret_key');
delete_site_option('nis2_captcha_secret_key');
delete_option('nis2_ip_whitelist');
delete_site_option('nis2_ip_whitelist');
delete_option('nis2_ip_blacklist');
delete_site_option('nis2_ip_blacklist');
delete_option('nis2_blocked_countries');
delete_site_option('nis2_blocked_countries');
delete_option('nis2_session_timeout');
delete_site_option('nis2_session_timeout');
delete_option('nis2_limit_concurrent_sessions');
delete_site_option('nis2_limit_concurrent_sessions');
delete_option('nis2_vulnerability_scanning_enabled');
delete_site_option('nis2_vulnerability_scanning_enabled');
delete_option('nis2_vulnerability_scan_frequency');
delete_site_option('nis2_vulnerability_scan_frequency');
delete_option('nis2_vulnerability_notifications');
delete_site_option('nis2_vulnerability_notifications');
delete_option('nis2_vulnerability_auto_fix');
delete_site_option('nis2_vulnerability_auto_fix');
delete_option('nis2_integrity_enabled');
delete_site_option('nis2_integrity_enabled');
delete_option('nis2_integrity_frequency');
delete_site_option('nis2_integrity_frequency');
delete_option('nis2_integrity_email_alerts');
delete_site_option('nis2_integrity_email_alerts');
delete_option('nis2_monitor_core');
delete_site_option('nis2_monitor_core');
delete_option('nis2_monitor_plugins');
delete_site_option('nis2_monitor_plugins');
delete_option('nis2_monitor_themes');
delete_site_option('nis2_monitor_themes');
delete_option('nis2_monitor_uploads');
delete_site_option('nis2_monitor_uploads');
delete_option('nis2_monitor_custom_paths');
delete_site_option('nis2_monitor_custom_paths');
delete_option('nis2_monitor_file_types');
delete_site_option('nis2_monitor_file_types');
delete_option('nis2_monitor_excluded_paths');
delete_site_option('nis2_monitor_excluded_paths');
delete_option('nis2_ignore_temp_files');
delete_site_option('nis2_ignore_temp_files');
delete_option('nis2_max_files_per_scan');
delete_site_option('nis2_max_files_per_scan');
delete_option('nis2_memory_limit');
delete_site_option('nis2_memory_limit');
delete_option('nis2_background_scanning');
delete_site_option('nis2_background_scanning');
delete_option('nis2_notification_frequency');
delete_site_option('nis2_notification_frequency');
delete_option('nis2_notification_emails');
delete_site_option('nis2_notification_emails');
delete_option('nis2_notification_levels');
delete_site_option('nis2_notification_levels');
delete_option('nis2_email_template');
delete_site_option('nis2_email_template');
delete_option('nis2_slack_enabled');
delete_site_option('nis2_slack_enabled');
delete_option('nis2_slack_webhook');
delete_site_option('nis2_slack_webhook');
delete_option('nis2_slack_channel');
delete_site_option('nis2_slack_channel');
delete_option('nis2_slack_severity');
delete_site_option('nis2_slack_severity');
delete_option('nis2_telegram_enabled');
delete_site_option('nis2_telegram_enabled');
delete_option('nis2_telegram_bot_token');
delete_site_option('nis2_telegram_bot_token');
delete_option('nis2_telegram_chat_id');
delete_site_option('nis2_telegram_chat_id');
delete_option('nis2_telegram_severity');
delete_site_option('nis2_telegram_severity');
delete_option('nis2_custom_webhook_enabled');
delete_site_option('nis2_custom_webhook_enabled');
delete_option('nis2_custom_webhook_urls');
delete_site_option('nis2_custom_webhook_urls');
delete_option('nis2_webhook_auth_header');
delete_site_option('nis2_webhook_auth_header');
delete_option('nis2_webhook_format');
delete_site_option('nis2_webhook_format');
delete_option('nis2_security_policy_documented');
delete_site_option('nis2_security_policy_documented');
delete_option('nis2_transparency_enabled');
delete_site_option('nis2_transparency_enabled');
delete_option('nis2_debug_mode');
delete_site_option('nis2_debug_mode');
delete_option('nis2_debug_log_path');
delete_site_option('nis2_debug_log_path');
delete_option('nis2_verbose_logging');
delete_site_option('nis2_verbose_logging');
delete_option('nis2_api_enabled');
delete_site_option('nis2_api_enabled');
delete_option('nis2_api_key');
delete_site_option('nis2_api_key');
delete_option('nis2_api_rate_limit');
delete_site_option('nis2_api_rate_limit');
delete_option('nis2_api_allowed_ips');
delete_site_option('nis2_api_allowed_ips');
delete_option('nis2_table_prefix');
delete_site_option('nis2_table_prefix');
delete_option('nis2_auto_optimize_db');
delete_site_option('nis2_auto_optimize_db');
delete_option('nis2_auto_create_indexes');
delete_site_option('nis2_auto_create_indexes');
delete_option('nis2_query_timeout');
delete_site_option('nis2_query_timeout');
delete_option('nis2_dashboard_theme');
delete_site_option('nis2_dashboard_theme');
delete_option('nis2_hide_admin_bar');
delete_site_option('nis2_hide_admin_bar');
delete_option('nis2_uninstall_data');
delete_site_option('nis2_uninstall_data');
delete_option('nis2_export_before_uninstall');
delete_site_option('nis2_export_before_uninstall');
delete_option('nis2_api_timeout');
delete_site_option('nis2_api_timeout');
delete_option('nis2_cache_duration');
delete_site_option('nis2_cache_duration');
delete_option('nis2_plugin_integrations');
delete_site_option('nis2_plugin_integrations');
delete_option('nis2_suppress_mode');
delete_site_option('nis2_suppress_mode');
delete_option('nis2_report');
delete_site_option('nis2_report');
delete_option('nis2_last_integrity_scan');
delete_site_option('nis2_last_integrity_scan');
delete_option('nis2_vuln_auto_scan');
delete_site_option('nis2_vuln_auto_scan');
delete_option('nis2_vuln_email_alerts');
delete_site_option('nis2_vuln_email_alerts');
delete_option('nis2_vuln_sources');
delete_site_option('nis2_vuln_sources');
delete_option('nis2_require_2fa_admin');
delete_site_option('nis2_require_2fa_admin');
delete_option('nis2_monitoring_enabled');
delete_site_option('nis2_monitoring_enabled');
delete_option('nis2_last_integrity_check');
delete_site_option('nis2_last_integrity_check');
delete_option('nis2_last_vulnerability_scan');
delete_site_option('nis2_last_vulnerability_scan');
delete_option('nis2_incident_procedures_documented');
delete_site_option('nis2_incident_procedures_documented');
delete_option('_nis2_pre_update_version');
delete_site_option('_nis2_pre_update_version');
delete_option('nis2_custom_monitored_paths');
delete_site_option('nis2_custom_monitored_paths');
delete_option('nis2_scan_frequency');
delete_site_option('nis2_scan_frequency');
delete_option('nis2_wpscan_api_token');
delete_site_option('nis2_wpscan_api_token');
delete_option('nis2_db_version');
delete_site_option('nis2_db_version');
global $wpdb;
$options = $wpdb->get_col( $wpdb->prepare( "SELECT option_name FROM {$wpdb->options} WHERE option_name LIKE %s", 'nis2_%' ) );
foreach ( $options as $opt ) {
	delete_option( $opt );
	delete_site_option( $opt );
}
delete_option('nis2_public_transparency');
delete_site_option('nis2_public_transparency');
delete_option('nis2_footer_badge');
delete_site_option('nis2_footer_badge');
delete_option('nis2_last_security_update');
delete_site_option('nis2_last_security_update');

// Delete Transients
delete_transient('update_core');
delete_site_transient('update_core');
delete_transient('nis2_blocked_ips');
delete_site_transient('nis2_blocked_ips');
global $wpdb;
$transients = $wpdb->get_col( $wpdb->prepare( "SELECT option_name FROM {$wpdb->options} WHERE option_name LIKE %s OR option_name LIKE %s", '_transient_nis2_attempts_%', '_site_transient_nis2_attempts_%' ) );
foreach ( $transients as $transient ) {
	delete_option( $transient );
}
delete_transient('nis2_integrity_scan_running');
delete_site_transient('nis2_integrity_scan_running');

// Clear Cron Jobs
wp_clear_scheduled_hook('nis2_integrity_check');
wp_clear_scheduled_hook('nis2_vulnerability_check');
wp_clear_scheduled_hook('nis2_daily_scan');

// Clear Metadata
global $wpdb;
$wpdb->query( $wpdb->prepare( "DELETE FROM {$wpdb->postmeta} WHERE meta_key = %s", 'nis2_2fa_code' ) );
$wpdb->query( $wpdb->prepare( "DELETE FROM {$wpdb->usermeta} WHERE meta_key = %s", 'nis2_2fa_code' ) );
$wpdb->query( $wpdb->prepare( "DELETE FROM {$wpdb->termmeta} WHERE meta_key = %s", 'nis2_2fa_code' ) );
$wpdb->query( $wpdb->prepare( "DELETE FROM {$wpdb->commentmeta} WHERE meta_key = %s", 'nis2_2fa_code' ) );
$wpdb->query( $wpdb->prepare( "DELETE FROM {$wpdb->postmeta} WHERE meta_key = %s", 'nis2_2fa_expires' ) );
$wpdb->query( $wpdb->prepare( "DELETE FROM {$wpdb->usermeta} WHERE meta_key = %s", 'nis2_2fa_expires' ) );
$wpdb->query( $wpdb->prepare( "DELETE FROM {$wpdb->termmeta} WHERE meta_key = %s", 'nis2_2fa_expires' ) );
$wpdb->query( $wpdb->prepare( "DELETE FROM {$wpdb->commentmeta} WHERE meta_key = %s", 'nis2_2fa_expires' ) );

